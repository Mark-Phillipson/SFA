Pa@using System.Globalization
@using System.Linq
@using System.Net.Http
@using System.Net.Http.Json
@using System.Threading.Tasks
@inject HttpClient Http
@inject IJSRuntime JS



@* Google Map of all cafes link (prominent banner/button) *@
<div style="margin-bottom: 1.5em; text-align: center;">
    <a href="https://www.google.com/maps/d/u/0/viewer?hl=en_GB&ll=51.16496111227416%2C0.6610910499999934&mid=1ZbfDVSgeG70tAx6jdZtpBFBIFFU&z=9" target="_blank" rel="noopener noreferrer"
       style="display: inline-block; background: linear-gradient(90deg, #007bff 60%, #00c6ff 100%); color: #fff; font-size: 1.3em; font-weight: 600; padding: 1em 2em; border-radius: 1.2em; box-shadow: 0 2px 8px rgba(0,0,0,0.10); text-decoration: none; transition: background 0.2s, box-shadow 0.2s; margin-bottom: 0.5em;">
        üó∫Ô∏è View All Cafes on Google Map
    </a>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <input type="text" @bind-value="filter" @bind-value:event="oninput" placeholder="Filter cafes by name or description..." class="form-control" @ref="filterBoxRef" />
    </div>
    <div class="col-md-6">
        <input type="text" @bind-value="locationInput" placeholder="Enter a location (e.g. Marden)..." class="form-control" />
        <button class="btn btn-primary mt-2" @onclick="OnLocationSearch">Search Nearby Cafes</button>
    </div>
</div>
@if (cafes == null)
{
    <p>Loading cafes...</p>
}
else
{
    <table class="table table-striped cafe-table-responsive">
        <thead>
            <tr>
                <th>Name</th>
                <th>Map</th>
                <th>Location</th>
                <th class="desc-header">Description</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var cafe in FilteredCafes)
        {
            <tr class="cafe-row-group">
                <td>@cafe.Name</td>
                <td>
                    @if (!string.IsNullOrWhiteSpace(cafe.LatLong) && cafe.LatLong.Contains(','))
                    {
                        <button class="btn btn-sm btn-outline-primary" @onclick="@(() => OpenMapAsync(cafe.LatLong!))">Map</button>
                    }
                </td>
                <td>@(cafe.Location ?? "")</td>
                <td class="desc-cell desktop-only">@cafe.Description</td>
            </tr>
            <tr class="mobile-desc-row cafe-row-group">
                <td colspan="4" class="desc-cell mobile-only">@cafe.Description</td>
            </tr>
        }
        </tbody>
    </table>
}

@code {
    private List<Cafe>? cafes;
    private string filter = string.Empty;
    private string locationInput = string.Empty;
    private ElementReference filterBoxRef;
    private bool _focusSet = false;

    private double? searchLat;
    private double? searchLng;

    private async Task OnLocationSearch()
    {
        if (string.IsNullOrWhiteSpace(locationInput)) return;
        // Use OpenStreetMap Nominatim API for geocoding
        var url = $"https://nominatim.openstreetmap.org/search?format=json&q={Uri.EscapeDataString(locationInput)}";
        var results = await Http.GetFromJsonAsync<List<NominatimResult>>(url);
        if (results != null && results.Count > 0)
        {
            searchLat = double.Parse(results[0].lat, CultureInfo.InvariantCulture);
            searchLng = double.Parse(results[0].lon, CultureInfo.InvariantCulture);
        }
        else
        {
            searchLat = null;
            searchLng = null;
        }
        // Next step: filter cafes by proximity
    }

    public class NominatimResult
    {
        public string lat { get; set; } = "";
        public string lon { get; set; } = "";
        public string display_name { get; set; } = "";
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_focusSet)
        {
            _focusSet = true;
            await JS.InvokeVoidAsync("eval", "setTimeout(()=>document.querySelector('[placeholder=\\'Filter cafes by name or description...\\']')?.focus(),0)");
        }
    }


    protected override async Task OnInitializedAsync()
    {
        // Fetch CSV from wwwroot/sample-data/CafeList-CSV.csv
        var csvUrl = "sample-data/CafeList-CSV.csv";
        var csvContent = await Http.GetStringAsync(csvUrl);
        cafes = LoadCafesFromString(csvContent);
    }

    // Haversine formula to calculate distance (km) between two lat/lng points
    private static double CalculateDistance(double lat1, double lon1, double lat2, double lon2)
    {
        const double R = 6371; // Earth radius in km
        var dLat = Math.PI * (lat2 - lat1) / 180.0;
        var dLon = Math.PI * (lon2 - lon1) / 180.0;
        lat1 = Math.PI * lat1 / 180.0;
        lat2 = Math.PI * lat2 / 180.0;
        var a = Math.Sin(dLat / 2) * Math.Sin(dLat / 2) +
                Math.Sin(dLon / 2) * Math.Sin(dLon / 2) * Math.Cos(lat1) * Math.Cos(lat2);
        var c = 2 * Math.Asin(Math.Sqrt(a));
        return R * c;
    }

    private IEnumerable<Cafe> FilteredCafes
    {
        get
        {
            if (cafes == null)
                return Enumerable.Empty<Cafe>();

            var filtered = string.IsNullOrWhiteSpace(filter)
                ? cafes
                : cafes.Where(c => ((c.Name ?? "") + " " + (c.Description ?? "")).Contains(filter, StringComparison.OrdinalIgnoreCase)).ToList();

            // If user searched for a location, filter by proximity (e.g., 5km radius)
            if (searchLat.HasValue && searchLng.HasValue)
            {
                foreach (var cafe in filtered)
                {
                    cafe.Location = null;
                    if (!string.IsNullOrWhiteSpace(cafe.LatLong) && cafe.LatLong.Contains(','))
                    {
                        var parts = cafe.LatLong.Split(',');
                        if (parts.Length == 2 && double.TryParse(parts[0], out var lat) && double.TryParse(parts[1], out var lng))
                        {
                            var dist = CalculateDistance(searchLat.Value, searchLng.Value, lat, lng);
                            if (dist <= 5.0) // 5km radius
                            {
                                cafe.Location = locationInput; // Show searched location name
                            }
                        }
                    }
                }
                // Only show cafes within radius
                filtered = filtered.Where(c => c.Location != null).ToList();
            }
            return filtered.OrderBy(c => c.Name);
        }
    }
    private async Task OpenMapAsync(string latLong)
    {
        var parts = latLong.Split(',');
        if (parts.Length == 2 && double.TryParse(parts[0], out var lat) && double.TryParse(parts[1], out var lng))
        {
            var url = $"https://www.google.com/maps?q={lat},{lng}";
            if (JS != null)
            {
                await JS.InvokeVoidAsync("open", url, "_blank");
            }
        }
    }


    private List<Cafe> LoadCafesFromString(string csv)
    {
        var lines = csv.Split('\n').Select(l => l.Trim()).Where(l => !string.IsNullOrWhiteSpace(l)).ToList();
        var list = new List<Cafe>();
        foreach (var line in lines.Skip(1)) // skip header
        {
            var parts = SplitCsvLine(line);
            if (parts.Length >= 3)
            {
                list.Add(new Cafe
                {
                    Name = parts[0],
                    LatLong = parts[1],
                    Description = parts[2]
                });
            }
        }
        return list;
    }

    private string[] SplitCsvLine(string line)
    {
        // Simple CSV split, handles quoted fields
        var result = new List<string>();
        bool inQuotes = false;
        var value = "";
        foreach (var c in line)
        {
            if (c == '"')
            {
                inQuotes = !inQuotes;
            }
            else if (c == ',' && !inQuotes)
            {
                result.Add(value);
                value = "";
            }
            else
            {
                value += c;
            }
        }
        result.Add(value);
        return result.ToArray();
    }

    public class Cafe
    {
        public string? Name { get; set; }
        public string? LatLong { get; set; }
        public string? Description { get; set; }
        public string? Location { get; set; } // For nearest area/town
    }
}
