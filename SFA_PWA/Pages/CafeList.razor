@using System.Globalization
@using System.Linq
@using System.Net.Http
@using System.Net.Http.Json
@using System.Threading.Tasks
@inject HttpClient Http
@inject IJSRuntime JS

@inject SFA_PWA.Services.GoogleSheetCafeService GoogleSheetCafeService

@using SFA_PWA.Models



@* Google Map of all cafes link (prominent banner/button) *@
<div class="hide-on-mobile" style="margin-bottom: 1.5em; text-align: center;">
    <a href="https://www.google.com/maps/d/u/0/viewer?hl=en_GB&ll=51.286400,0.495071&mid=1ZbfDVSgeG70tAx6jdZtpBFBIFFU&z=10" target="_blank" rel="noopener noreferrer"
       style="display: inline-block; background: linear-gradient(90deg, #007bff 60%, #00c6ff 100%); color: #fff; font-size: 1.3em; font-weight: 600; padding: 1em 2em; border-radius: 1.2em; box-shadow: 0 2px 8px rgba(0,0,0,0.10); text-decoration: none; transition: background 0.2s, box-shadow 0.2s; margin-bottom: 0.5em;">
        üó∫Ô∏è View All Cafes on Google Map
    </a>
</div>

@* Helper text for searching/filtering cafes (dismissible) *@
@if (showHelperText)
{
    <div class="alert alert-info alert-dismissible fade show" style="margin-bottom: 1.2em; position: relative;">
        <button type="button" class="btn-close" style="position: absolute; top: 0.7em; right: 1em;" @onclick="() => showHelperText = false" aria-label="Close"></button>
        <strong>How to use the cafes list:</strong>
        <ul style="margin-top:0.5em; margin-bottom:0.5em;">
            <li>Use the <b>General search</b> box to find cafes by name, address, postcode, or notes.</li>
            <li>Filter by <b>Place</b> using the dropdown to narrow results to a specific town or area.</li>
            <li>To find cafes near a destination, enter a <b>placename or postcode</b> and click <b>Search Nearby</b>. Adjust the <b>radius</b> to expand or narrow your search.</li>
            <li>Clear your search or filters at any time to see all cafes again.</li>
        </ul>
    </div>
}

<div class="row mb-3">
    <div class="col-md-6">
        <input type="text" @bind-value="locationInput" @bind-value:event="oninput" placeholder="üìç Type a placename or postcode..." class="form-control" @onkeyup="OnLocationKeyUp" />
    </div>
    <div class="col-md-2">
        <button class="btn btn-primary w-100" @onclick="OnLocationSearch" disabled="@(isSearching)">üó∫Ô∏è Search Nearby</button>
    </div>
    <div class="col-md-2">
        <button class="btn btn-secondary w-100" @onclick="ClearLocationSearch">‚ùå Clear</button>
    </div>
    <div class="col-md-2">
        <input type="number" min="1" max="100" class="form-control" style="width:100%;" @bind="searchRadius" />
        <span style="font-size:0.9em;">Radius (miles)</span>
    </div>
</div>
<div class="row mb-2">
    <div class="col-12">
        @if (!string.IsNullOrWhiteSpace(searchMessage))
        {
            <div class="alert alert-info">@searchMessage</div>
        }
        @if (!string.IsNullOrWhiteSpace(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }
    </div>
</div>
<div class="cafe-filter-row mb-3">
    <div class="cafe-filter-half">
        <input type="text" @bind-value="filter" @bind-value:event="oninput" placeholder="üîé General search..." class="form-control" @ref="filterBoxRef" />
    </div>
    <div class="cafe-filter-half">
        <select @bind="selectedPlace" class="form-select">
            <option value="">All Places</option>
            @foreach (var place in Places)
            {
                <option value="@place">@place</option>
            }
        </select>
    </div>
</div>
@if (cafes == null)
{
    <p>Loading cafes...</p>
}
else
{
    <div class="cafe-card-list">
        @foreach (var cafe in FilteredCafes)
        {
            <div class="cafe-card" style="cursor:pointer; position:relative; min-height:180px;" @onclick="() => OpenCafeMap(cafe)">
                <div class="cafe-card-header">
                    <div class="cafe-name" style="display:block; text-align:left;">@cafe.Name</div>
                </div>
                <div class="cafe-card-body" style="padding-bottom:2.5em;">
                    @if (!string.IsNullOrWhiteSpace(cafe.Address))
                    {
                        <div><strong>Address:</strong> @cafe.Address</div>
                    }
                    @if (!string.IsNullOrWhiteSpace(cafe.Place))
                    {
                        <div><strong>Place:</strong> @cafe.Place</div>
                    }
                    @if (!string.IsNullOrWhiteSpace(cafe.Postcode))
                    {
                        <div><strong>Postcode:</strong> @cafe.Postcode</div>
                    }
                    @if (!string.IsNullOrWhiteSpace(cafe.Tel))
                    {
                        <div><strong>Tel:</strong> <span class="cafe-tel">@cafe.Tel</span></div>
                    }
                    @if (!string.IsNullOrWhiteSpace(cafe.Notes))
                    {
                        <div class="cafe-notes"><strong>Notes:</strong> @cafe.Notes</div>
                    }
                </div>
                <div style="position:absolute; bottom:0.7em; right:0.7em; z-index:2;">
                    <button class="btn btn-light btn-sm" title="Search Google for official website" style="padding:0.35em 0.6em; border-radius:0.7em; border:1px solid #eee; box-shadow:0 1px 4px rgba(0,0,0,0.07);" @onclick="(e) => FindWebsiteAsync(cafe, e)" @onclick:stopPropagation="true">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="22" height="22" style="vertical-align:middle;">
                            <g>
                                <circle cx="24" cy="24" r="20" fill="#fff"/>
                                <path fill="#4285F4" d="M34.6 24.3c0-1.1-.1-2.1-.3-3.1H24v5.9h6c-.3 1.6-1.3 2.9-2.7 3.8v3.1h4.4c2.6-2.4 4.1-5.9 4.1-9.7z"/>
                                <path fill="#34A853" d="M24 38c2.7 0 5-0.9 6.7-2.4l-4.4-3.1c-1.2 0.8-2.7 1.3-4.3 1.3-3.3 0-6.1-2.2-7.1-5.2h-4.4v3.2C12.7 35.8 18 38 24 38z"/>
                                <path fill="#FBBC05" d="M16.9 28.6c-0.3-0.8-0.5-1.7-0.5-2.6s0.2-1.8 0.5-2.6v-3.2h-4.4C11.7 22.2 11 23.9 11 25.7s0.7 3.5 1.5 5.1l4.4-3.2z"/>
                                <path fill="#EA4335" d="M24 18.7c1.5 0 2.8 0.5 3.8 1.4l2.8-2.8C28.9 15.9 26.7 15 24 15c-6 0-11.3 2.2-14.9 5.7l4.4 3.2c1-3 3.8-5.2 7.1-5.2z"/>
                            </g>
                        </svg>
                    </button>
                </div>
            </div>
        }
    </div>
}

@code {
    private List<Cafe>? cafes;
    private string filter = string.Empty;
    private string selectedPlace = string.Empty;
    // Status filter removed
    private bool showHelperText = true;

    private IEnumerable<string> Places =>
        cafes == null
            ? Enumerable.Empty<string>()
            : cafes
                .Select(c => (c.Place ?? "").Trim())
                .Where(p => !string.IsNullOrWhiteSpace(p))
                .GroupBy(p => p.ToLowerInvariant())
                .Select(g => g.First())
                .OrderBy(p => p);
    // Statuses property removed
    private string locationInput = string.Empty;
    private ElementReference filterBoxRef;
    private bool _focusSet = false;

    private double? searchLat;
    private double? searchLng;
    private int searchRadius = 10; // Default 10km
    private bool isSearching = false;
    private string searchMessage = string.Empty;
    private string errorMessage = string.Empty;

    private async Task OnLocationKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await OnLocationSearch();
        }
    }

    private async Task OnLocationSearch()
    {
        if (string.IsNullOrWhiteSpace(locationInput))
        {
            errorMessage = "Please enter a location to search.";
            return;
        }

        isSearching = true;
        errorMessage = string.Empty;
        searchMessage = string.Empty;
        StateHasChanged();

        try
        {
            // Use OpenStreetMap Nominatim API for geocoding
            var url = $"https://nominatim.openstreetmap.org/search?format=json&q={Uri.EscapeDataString(locationInput)}&countrycodes=gb&limit=1";
            var results = await Http.GetFromJsonAsync<List<NominatimResult>>(url);
            
            if (results != null && results.Count > 0)
            {
                searchLat = double.Parse(results[0].lat, CultureInfo.InvariantCulture);
                searchLng = double.Parse(results[0].lon, CultureInfo.InvariantCulture);

                // Calculate distance for each cafe using LatLong field
                foreach (var cafe in cafes ?? new List<Cafe>())
                {
                    cafe.Location = null;
                    cafe.Distance = null;
                    if (!string.IsNullOrWhiteSpace(cafe.LatLong) && cafe.LatLong.Contains(','))
                    {
                        var parts = cafe.LatLong.Split(',');
                        if (parts.Length == 2 && double.TryParse(parts[0], out var lat) && double.TryParse(parts[1], out var lng))
                        {
                            var dist = CalculateDistance(searchLat.Value, searchLng.Value, lat, lng);
                            cafe.Distance = dist;
                            if (dist <= searchRadius)
                            {
                                cafe.Location = $"{dist:F1} miles from {locationInput}";
                            }
                        }
                    }
                }
                var nearbyCount = (cafes ?? new List<Cafe>()).Count(c => c.Location != null);
                searchMessage = $"Found {nearbyCount} cafe(s) within {searchRadius} miles of {results[0].display_name}";
                errorMessage = string.Empty;
            }
            else
            {
                searchLat = null;
                searchLng = null;
                errorMessage = $"Location '{locationInput}' not found. Try a nearby town or postcode.";
                searchMessage = string.Empty;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error searching location: {ex.Message}";
            searchLat = null;
            searchLng = null;
        }
        finally
        {
            isSearching = false;
            StateHasChanged();
        }
    }

    private void ClearLocationSearch()
    {
        locationInput = string.Empty;
        searchMessage = string.Empty;
        errorMessage = string.Empty;
        filter = string.Empty;
        selectedPlace = string.Empty;
        // selectedStatus reset removed
        // Reset cafes to full list (refetch from Google Sheets)
        _ = OnInitializedAsync();
    }

    public class NominatimResult
    {
        public string lat { get; set; } = "";
        public string lon { get; set; } = "";
        public string display_name { get; set; } = "";
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_focusSet)
        {
            _focusSet = true;
            await JS.InvokeVoidAsync("eval", "setTimeout(()=>document.querySelector('[placeholder=\\'Filter cafes by name or description...\\']')?.focus(),0)");
        }
    }


    protected override async Task OnInitializedAsync()
        {
            // Fetch cafes from Google Sheets (read-only)
            cafes = await GoogleSheetCafeService.GetCafesAsync();
        }

    // Haversine formula to calculate distance (km) between two lat/lng points
    // Haversine formula to calculate distance (miles) between two lat/lng points
    private static double CalculateDistance(double lat1, double lon1, double lat2, double lon2)
    {
        const double R = 3958.8; // Earth radius in miles
        var dLat = Math.PI * (lat2 - lat1) / 180.0;
        var dLon = Math.PI * (lon2 - lon1) / 180.0;
        lat1 = Math.PI * lat1 / 180.0;
        lat2 = Math.PI * lat2 / 180.0;
        var a = Math.Sin(dLat / 2) * Math.Sin(dLat / 2) +
                Math.Sin(dLon / 2) * Math.Sin(dLon / 2) * Math.Cos(lat1) * Math.Cos(lat2);
        var c = 2 * Math.Asin(Math.Sqrt(a));
        return R * c;
    }

    private IEnumerable<Cafe> FilteredCafes
    {
        get
        {
            if (cafes == null)
                return Enumerable.Empty<Cafe>();

            var filtered = (cafes ?? new List<Cafe>())
                .Where(c => !string.IsNullOrWhiteSpace(c.Name) && c.Name != "Name")
                .ToList();

            // Apply Place filter (case-insensitive, trimmed)
            if (!string.IsNullOrWhiteSpace(selectedPlace))
                filtered = filtered.Where(c => string.Equals((c.Place ?? "").Trim(), selectedPlace.Trim(), StringComparison.OrdinalIgnoreCase)).ToList();

            // Status filter removed

            // Apply general text filter
            if (!string.IsNullOrWhiteSpace(filter))
            {
                filtered = filtered.Where(c =>
                    ((c.Status ?? "") + " " +
                     (c.Name ?? "") + " " +
                     (c.Address ?? "") + " " +
                     (c.Place ?? "") + " " +
                     (c.Postcode ?? "") + " " +
                     (c.Tel ?? "") + " " +
                     (c.Notes ?? "")
                    ).Contains(filter, StringComparison.OrdinalIgnoreCase)
                ).ToList();
            }

            // If user searched for a location, filter by proximity using LatLong
            if (searchLat.HasValue && searchLng.HasValue)
            {
                foreach (var cafe in filtered)
                {
                    cafe.Location = null;
                    cafe.Distance = null;
                    if (!string.IsNullOrWhiteSpace(cafe.LatLong) && cafe.LatLong.Contains(','))
                    {
                        var parts = cafe.LatLong.Split(',');
                        if (parts.Length == 2 && double.TryParse(parts[0], out var lat) && double.TryParse(parts[1], out var lng))
                        {
                            var dist = CalculateDistance(searchLat.Value, searchLng.Value, lat, lng);
                            cafe.Distance = dist;
                            if (dist <= searchRadius)
                            {
                                cafe.Location = $"{dist:F1} miles from {locationInput}";
                            }
                        }
                    }
                }
                // Only show cafes within radius and sort by distance
                return filtered.Where(c => c.Location != null).OrderBy(c => c.Distance);
            }

            // Default: clear location data and sort by name
            foreach (var cafe in filtered)
            {
                cafe.Location = null;
                cafe.Distance = null;
            }
            return filtered.OrderBy(c => c.Name);
        }
    }
    private async Task OpenCafeMap(Cafe cafe)
    {
        string? url = null;
        if (!string.IsNullOrWhiteSpace(cafe.LatLong) && cafe.LatLong.Contains(','))
        {
            var parts = cafe.LatLong.Split(',');
            if (parts.Length == 2 && double.TryParse(parts[0], out var lat) && double.TryParse(parts[1], out var lng))
            {
                url = $"https://www.google.com/maps?q={lat},{lng}";
            }
        }
        else if (!string.IsNullOrWhiteSpace(cafe.GoogleMapLink))
        {
            url = cafe.GoogleMapLink;
        }
        if (url != null && JS != null)
        {
            await JS.InvokeVoidAsync("open", url, "_blank");
        }
    }

    // Open Google search for the cafe's official website
    private async Task FindWebsiteAsync(Cafe cafe, MouseEventArgs e)
    {
        string query = $"{cafe.Name} {cafe.Place} {cafe.Postcode} official website";
        string googleUrl = $"https://www.google.com/search?q={Uri.EscapeDataString(query)}";
        await JS.InvokeVoidAsync("open", googleUrl, "_blank");
    }


    // Removed CSV loading logic; now using Google Sheets API

    // Use shared Cafe model from SFA_PWA.Models
}
