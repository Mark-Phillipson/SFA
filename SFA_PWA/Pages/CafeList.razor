@using System.Globalization
@using System.Linq
@using System.Net.Http
@using System.Net.Http.Json
@using System.Threading.Tasks
@inject HttpClient Http
@inject IJSRuntime JS

@inject SFA_PWA.Services.GoogleSheetCafeService GoogleSheetCafeService

@using SFA_PWA.Models



@* Google Map of all cafes link (prominent banner/button) *@
<div style="margin-bottom: 1.5em; text-align: center;">
    <a href="https://www.google.com/maps/d/u/0/viewer?hl=en_GB&ll=51.286400,0.495071&mid=1ZbfDVSgeG70tAx6jdZtpBFBIFFU&z=10" target="_blank" rel="noopener noreferrer"
       style="display: inline-block; background: linear-gradient(90deg, #007bff 60%, #00c6ff 100%); color: #fff; font-size: 1.3em; font-weight: 600; padding: 1em 2em; border-radius: 1.2em; box-shadow: 0 2px 8px rgba(0,0,0,0.10); text-decoration: none; transition: background 0.2s, box-shadow 0.2s; margin-bottom: 0.5em;">
        üó∫Ô∏è View All Cafes on Google Map
    </a>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <input type="text" @bind-value="locationInput" @bind-value:event="oninput" placeholder="üìç Type a placename or postcode..." class="form-control" @onkeyup="OnLocationKeyUp" />
    </div>
    <div class="col-md-2">
        <button class="btn btn-primary w-100" @onclick="OnLocationSearch" disabled="@(isSearching)">üó∫Ô∏è Search Nearby</button>
    </div>
    <div class="col-md-2">
        <button class="btn btn-secondary w-100" @onclick="ClearLocationSearch">‚ùå Clear</button>
    </div>
    <div class="col-md-2">
        <input type="number" min="1" max="100" class="form-control" style="width:100%;" @bind="searchRadius" />
        <span style="font-size:0.9em;">Radius (miles)</span>
    </div>
</div>
<div class="row mb-2">
    <div class="col-12">
        @if (!string.IsNullOrWhiteSpace(searchMessage))
        {
            <div class="alert alert-info">@searchMessage</div>
        }
        @if (!string.IsNullOrWhiteSpace(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }
    </div>
</div>
<div class="row mb-3">
    <div class="col-md-4">
        <input type="text" @bind-value="filter" @bind-value:event="oninput" placeholder="üîé General search..." class="form-control" @ref="filterBoxRef" />
    </div>
    <div class="col-md-4">
        <select @bind="selectedPlace" class="form-select">
            <option value="">All Places</option>
            @foreach (var place in Places)
            {
                <option value="@place">@place</option>
            }
        </select>
    </div>
    <div class="col-md-4">
        <select @bind="selectedStatus" class="form-select">
            <option value="">All Statuses</option>
            @foreach (var status in Statuses)
            {
                <option value="@status">@status</option>
            }
        </select>
    </div>
</div>
@if (cafes == null)
{
    <p>Loading cafes...</p>
}
else
{
    <div class="cafe-card-list">
        @foreach (var cafe in FilteredCafes)
        {
            <div class="cafe-card" style="cursor:pointer" @onclick="() => OpenCafeMap(cafe)">
                <div class="cafe-card-header">
                    <span class="cafe-status">@cafe.Status</span>
                    <span class="cafe-name">@cafe.Name</span>
                </div>
                <div class="cafe-card-body">
                    <div><strong>Address:</strong> @cafe.Address</div>
                    <div><strong>Place:</strong> @cafe.Place</div>
                    <div><strong>Postcode:</strong> @cafe.Postcode</div>
                    <div><strong>Tel:</strong> @cafe.Tel</div>
                    @if (!string.IsNullOrWhiteSpace(cafe.Notes))
                    {
                        <div class="cafe-notes"><strong>Notes:</strong> @cafe.Notes</div>
                    }
                </div>
            </div>
        }
    </div>
}

@code {
    private List<Cafe>? cafes;
    private string filter = string.Empty;
    private string selectedPlace = string.Empty;
    private string selectedStatus = string.Empty;

    private IEnumerable<string> Places =>
        cafes == null
            ? Enumerable.Empty<string>()
            : cafes
                .Select(c => (c.Place ?? "").Trim())
                .Where(p => !string.IsNullOrWhiteSpace(p))
                .GroupBy(p => p.ToLowerInvariant())
                .Select(g => g.First())
                .OrderBy(p => p);
    private IEnumerable<string> Statuses => cafes?.Select(c => c.Status ?? "").Where(s => !string.IsNullOrWhiteSpace(s)).Distinct().OrderBy(s => s) ?? Enumerable.Empty<string>();
    private string locationInput = string.Empty;
    private ElementReference filterBoxRef;
    private bool _focusSet = false;

    private double? searchLat;
    private double? searchLng;
    private int searchRadius = 10; // Default 10km
    private bool isSearching = false;
    private string searchMessage = string.Empty;
    private string errorMessage = string.Empty;

    private async Task OnLocationKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await OnLocationSearch();
        }
    }

    private async Task OnLocationSearch()
    {
        if (string.IsNullOrWhiteSpace(locationInput))
        {
            errorMessage = "Please enter a location to search.";
            return;
        }

        isSearching = true;
        errorMessage = string.Empty;
        searchMessage = string.Empty;
        StateHasChanged();

        try
        {
            // Use OpenStreetMap Nominatim API for geocoding
            var url = $"https://nominatim.openstreetmap.org/search?format=json&q={Uri.EscapeDataString(locationInput)}&countrycodes=gb&limit=1";
            var results = await Http.GetFromJsonAsync<List<NominatimResult>>(url);
            
            if (results != null && results.Count > 0)
            {
                searchLat = double.Parse(results[0].lat, CultureInfo.InvariantCulture);
                searchLng = double.Parse(results[0].lon, CultureInfo.InvariantCulture);

                // Calculate distance for each cafe using LatLong field
                foreach (var cafe in cafes ?? new List<Cafe>())
                {
                    cafe.Location = null;
                    cafe.Distance = null;
                    if (!string.IsNullOrWhiteSpace(cafe.LatLong) && cafe.LatLong.Contains(','))
                    {
                        var parts = cafe.LatLong.Split(',');
                        if (parts.Length == 2 && double.TryParse(parts[0], out var lat) && double.TryParse(parts[1], out var lng))
                        {
                            var dist = CalculateDistance(searchLat.Value, searchLng.Value, lat, lng);
                            cafe.Distance = dist;
                            if (dist <= searchRadius)
                            {
                                cafe.Location = $"{dist:F1} miles from {locationInput}";
                            }
                        }
                    }
                }
                var nearbyCount = (cafes ?? new List<Cafe>()).Count(c => c.Location != null);
                searchMessage = $"Found {nearbyCount} cafe(s) within {searchRadius} miles of {results[0].display_name}";
                errorMessage = string.Empty;
            }
            else
            {
                searchLat = null;
                searchLng = null;
                errorMessage = $"Location '{locationInput}' not found. Try a nearby town or postcode.";
                searchMessage = string.Empty;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error searching location: {ex.Message}";
            searchLat = null;
            searchLng = null;
        }
        finally
        {
            isSearching = false;
            StateHasChanged();
        }
    }

    private void ClearLocationSearch()
    {
        locationInput = string.Empty;
        searchMessage = string.Empty;
        errorMessage = string.Empty;
        filter = string.Empty;
        selectedPlace = string.Empty;
        selectedStatus = string.Empty;
        // Reset cafes to full list (refetch from Google Sheets)
        _ = OnInitializedAsync();
    }

    public class NominatimResult
    {
        public string lat { get; set; } = "";
        public string lon { get; set; } = "";
        public string display_name { get; set; } = "";
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_focusSet)
        {
            _focusSet = true;
            await JS.InvokeVoidAsync("eval", "setTimeout(()=>document.querySelector('[placeholder=\\'Filter cafes by name or description...\\']')?.focus(),0)");
        }
    }


    protected override async Task OnInitializedAsync()
        {
            // Fetch cafes from Google Sheets (read-only)
            cafes = await GoogleSheetCafeService.GetCafesAsync();
        }

    // Haversine formula to calculate distance (km) between two lat/lng points
    // Haversine formula to calculate distance (miles) between two lat/lng points
    private static double CalculateDistance(double lat1, double lon1, double lat2, double lon2)
    {
        const double R = 3958.8; // Earth radius in miles
        var dLat = Math.PI * (lat2 - lat1) / 180.0;
        var dLon = Math.PI * (lon2 - lon1) / 180.0;
        lat1 = Math.PI * lat1 / 180.0;
        lat2 = Math.PI * lat2 / 180.0;
        var a = Math.Sin(dLat / 2) * Math.Sin(dLat / 2) +
                Math.Sin(dLon / 2) * Math.Sin(dLon / 2) * Math.Cos(lat1) * Math.Cos(lat2);
        var c = 2 * Math.Asin(Math.Sqrt(a));
        return R * c;
    }

    private IEnumerable<Cafe> FilteredCafes
    {
        get
        {
            if (cafes == null)
                return Enumerable.Empty<Cafe>();

            var filtered = (cafes ?? new List<Cafe>())
                .Where(c => !string.IsNullOrWhiteSpace(c.Name) && c.Name != "Name")
                .ToList();

            // Apply Place filter (case-insensitive, trimmed)
            if (!string.IsNullOrWhiteSpace(selectedPlace))
                filtered = filtered.Where(c => string.Equals((c.Place ?? "").Trim(), selectedPlace.Trim(), StringComparison.OrdinalIgnoreCase)).ToList();

            // Apply Status filter
            if (!string.IsNullOrWhiteSpace(selectedStatus))
                filtered = filtered.Where(c => (c.Status ?? "") == selectedStatus).ToList();

            // Apply general text filter
            if (!string.IsNullOrWhiteSpace(filter))
            {
                filtered = filtered.Where(c =>
                    ((c.Status ?? "") + " " +
                     (c.Name ?? "") + " " +
                     (c.Address ?? "") + " " +
                     (c.Place ?? "") + " " +
                     (c.Postcode ?? "") + " " +
                     (c.Tel ?? "") + " " +
                     (c.Notes ?? "")
                    ).Contains(filter, StringComparison.OrdinalIgnoreCase)
                ).ToList();
            }

            // If user searched for a location, filter by proximity using LatLong
            if (searchLat.HasValue && searchLng.HasValue)
            {
                foreach (var cafe in filtered)
                {
                    cafe.Location = null;
                    cafe.Distance = null;
                    if (!string.IsNullOrWhiteSpace(cafe.LatLong) && cafe.LatLong.Contains(','))
                    {
                        var parts = cafe.LatLong.Split(',');
                        if (parts.Length == 2 && double.TryParse(parts[0], out var lat) && double.TryParse(parts[1], out var lng))
                        {
                            var dist = CalculateDistance(searchLat.Value, searchLng.Value, lat, lng);
                            cafe.Distance = dist;
                            if (dist <= searchRadius)
                            {
                                cafe.Location = $"{dist:F1} miles from {locationInput}";
                            }
                        }
                    }
                }
                // Only show cafes within radius and sort by distance
                return filtered.Where(c => c.Location != null).OrderBy(c => c.Distance);
            }

            // Default: clear location data and sort by name
            foreach (var cafe in filtered)
            {
                cafe.Location = null;
                cafe.Distance = null;
            }
            return filtered.OrderBy(c => c.Name);
        }
    }
    private async Task OpenCafeMap(Cafe cafe)
    {
        string? url = null;
        if (!string.IsNullOrWhiteSpace(cafe.LatLong) && cafe.LatLong.Contains(','))
        {
            var parts = cafe.LatLong.Split(',');
            if (parts.Length == 2 && double.TryParse(parts[0], out var lat) && double.TryParse(parts[1], out var lng))
            {
                url = $"https://www.google.com/maps?q={lat},{lng}";
            }
        }
        else if (!string.IsNullOrWhiteSpace(cafe.GoogleMapLink))
        {
            url = cafe.GoogleMapLink;
        }
        if (url != null && JS != null)
        {
            await JS.InvokeVoidAsync("open", url, "_blank");
        }
    }


    // Removed CSV loading logic; now using Google Sheets API

    // Use shared Cafe model from SFA_PWA.Models
}
