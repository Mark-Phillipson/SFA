@page "/settings"
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Web
@using System.Collections.Generic
<PageTitle>Groups/Settings</PageTitle>

<h1>Ride Group Preferences</h1>
<p>Select which San Fairy Ann ride groups you want to follow:</p>

<h2>Calendar View Preference</h2>
<div style="margin-bottom: 1em;">
    <label for="calendarView" style="font-size: 1.1em;">Default calendar view for desktop:</label>
    <select id="calendarView" @bind="calendarView" style="margin-left:1em;font-size:1.1em;padding:0.3em 1em;">
        <option value="MONTH">Month</option>
        <option value="WEEK">Week</option>
        <option value="AGENDA">Schedule</option>
    </select>
</div>


<h2>Available Groups</h2>
<div style="margin-bottom: 1em;">
    <label style="font-size: 1.1em;">
        <input type="checkbox" style="width: 1.3em; height: 1.3em; accent-color: #007bff; margin-right: 0.5em;" @bind="showOnlyFollowed" />
        Show only followed groups
    </label>
</div>
<div style="display: flex; flex-wrap: wrap; gap: 1.5rem;">
    @foreach (var group in FilteredGroups)
    {
        <div style="background: #f8f9fa; border-radius: 1em; box-shadow: 0 1px 4px rgba(0,0,0,0.04); padding: 1.2em; min-width: 280px; display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 0.5em;">
            <label style="display: flex; align-items: center; gap: 1em; font-size: 1.3em;">
                <input type="checkbox" checked="@IsSelected(group.Name)" @onchange="(e) => OnPreferenceChangedAndSave(group.Name, ((ChangeEventArgs)e).Value ?? false)" style="width: 2.2em; height: 2.2em; accent-color: #007bff;" />
                <span style="font-weight: bold;">@group.Name</span>
            </label>
            <span style="margin: 0.5em 0 1em 0; font-size: 1.1em; color: #333;">@group.Description</span>
            <div style="display: flex; gap: 1em;">
                <a href="@group.InfoUrl" target="_blank" class="btn btn-info btn-lg" style="font-size: 1.1em; padding: 0.8em 1.5em; border-radius: 0.7em;">Info</a>
                @if (!string.IsNullOrWhiteSpace(group.CalendarUrl))
                {
                    <a href="@group.CalendarUrl" target="_blank" class="btn btn-success btn-lg" style="font-size: 1.1em; padding: 0.8em 1.5em; border-radius: 0.7em;">Calendar</a>
                }
            </div>
        </div>
    }
</div>



@code {
    private Dictionary<string, bool> selectedGroups = new();
    private List<GroupData> groups = new();
    private bool showOnlyFollowed = false;

    private string _calendarView = "MONTH";
    private string calendarView
    {
        get => _calendarView;
        set
        {
            if (_calendarView != value)
            {
                _calendarView = value;
                JS.InvokeVoidAsync("localStorage.setItem", "calendarViewPreference", _calendarView);
            }
        }
    }

    private IEnumerable<GroupData> FilteredGroups => showOnlyFollowed
        ? groups.Where(g => IsSelected(g.Name))
        : groups;

    [Inject]
    private HttpClient Http { get; set; } = default!;
    [Inject]
    private IJSRuntime JS { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        // Load all groups from groups.json
        try
        {
            groups = await Http.GetFromJsonAsync<List<GroupData>>("sample-data/groups.json") ?? new List<GroupData>();
        }
        catch
        {
            groups = new List<GroupData>();
        }

        // Load user preferences from localStorage
        var prefsJson = await JS.InvokeAsync<string>("localStorage.getItem", "groupPreferences");
        if (!string.IsNullOrWhiteSpace(prefsJson))
        {
            selectedGroups = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, bool>>(prefsJson) ?? new Dictionary<string, bool>();
        }
        // Ensure all groups have a preference entry
        foreach (var group in groups)
        {
            if (!selectedGroups.ContainsKey(group.Name))
                selectedGroups[group.Name] = false;
        }

        // Set filter default: show only followed if any are followed
        showOnlyFollowed = selectedGroups.Values.Any(v => v);

            // Load calendar view preference
            var viewPref = await JS.InvokeAsync<string>("localStorage.getItem", "calendarViewPreference");
            if (!string.IsNullOrWhiteSpace(viewPref))
            {
                calendarView = viewPref;
            }
    }


    private async Task SavePreferences()
    {
        await JS.InvokeVoidAsync("localStorage.setItem", "groupPreferences", System.Text.Json.JsonSerializer.Serialize(selectedGroups));
            await JS.InvokeVoidAsync("localStorage.setItem", "calendarViewPreference", calendarView);
    }

    private async Task OnPreferenceChangedAndSave(string groupName, object? value)
    {
        bool isChecked = false;
        if (value is bool b)
            isChecked = b;
        else if (value is string s && bool.TryParse(s, out var parsed))
            isChecked = parsed;
        else if (value == null)
            isChecked = false;
        selectedGroups[groupName] = isChecked;
        await SavePreferences();
    }

    private bool IsSelected(string groupName)
    {
        return selectedGroups.ContainsKey(groupName) && selectedGroups[groupName];
    }

    private void OnPreferenceChanged(string groupName, object? value)
    {
        bool isChecked = false;
        if (value is bool b)
            isChecked = b;
        else if (value is string s && bool.TryParse(s, out var parsed))
            isChecked = parsed;
        else if (value == null)
            isChecked = false;
        selectedGroups[groupName] = isChecked;
    }

    public class GroupData
    {
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string InfoUrl { get; set; } = string.Empty;
        public string CalendarUrl { get; set; } = string.Empty;
    }

}