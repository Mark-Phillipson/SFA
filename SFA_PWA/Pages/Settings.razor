@page "/settings"
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Web
@using System.Collections.Generic
<PageTitle>Settings</PageTitle>

<h1>Ride Group Preferences</h1>
<p>Select which San Fairy Ann ride groups you want to follow:</p>

<h2>Available Groups</h2>
<ul>
    @foreach (var group in groups)
    {
        <li>
            <input type="checkbox" checked="@IsSelected(group.Name)" @onchange="(e) => OnPreferenceChanged(group.Name, ((ChangeEventArgs)e).Value)" />
            <b>@group.Name</b> - @group.Description
            <br />
            <a href="@group.InfoUrl" target="_blank">Info</a>
            @if (!string.IsNullOrWhiteSpace(group.CalendarUrl))
            {
                <span> | <a href="@group.CalendarUrl" target="_blank">Calendar</a></span>
            }
        </li>
    }
</ul>

<button class="btn btn-primary" @onclick="SavePreferences">Save Preferences</button>

@code {
    private Dictionary<string, bool> selectedGroups = new();
    private List<GroupData> groups = new();

    [Inject]
    private HttpClient Http { get; set; } = default!;
    [Inject]
    private IJSRuntime JS { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        // Load all groups from groups.json
        try
        {
            groups = await Http.GetFromJsonAsync<List<GroupData>>("sample-data/groups.json") ?? new List<GroupData>();
        }
        catch
        {
            groups = new List<GroupData>();
        }

        // Load user preferences from localStorage
        var prefsJson = await JS.InvokeAsync<string>("localStorage.getItem", "groupPreferences");
        if (!string.IsNullOrWhiteSpace(prefsJson))
        {
            selectedGroups = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, bool>>(prefsJson) ?? new Dictionary<string, bool>();
        }
        // Ensure all groups have a preference entry
        foreach (var group in groups)
        {
            if (!selectedGroups.ContainsKey(group.Name))
                selectedGroups[group.Name] = false;
        }
    }

    private async Task SavePreferences()
    {
        await JS.InvokeVoidAsync("localStorage.setItem", "groupPreferences", System.Text.Json.JsonSerializer.Serialize(selectedGroups));
    }

    private bool IsSelected(string groupName)
    {
        return selectedGroups.ContainsKey(groupName) && selectedGroups[groupName];
    }

    private void OnPreferenceChanged(string groupName, object value)
    {
        bool isChecked = false;
        if (value is bool b)
            isChecked = b;
        else if (value is string s && bool.TryParse(s, out var parsed))
            isChecked = parsed;
        selectedGroups[groupName] = isChecked;
    }

    public class GroupData
    {
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string InfoUrl { get; set; } = string.Empty;
        public string CalendarUrl { get; set; } = string.Empty;
    }
}